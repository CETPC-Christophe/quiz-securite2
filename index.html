<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QCM CACES ‚Äì Les travaux de terrassement</title>
<style>
  /* ---------- Th√®me & layout ---------- */
  :root { --orange:#ff6600; --noir:#222; --gris:#f3f3f3; }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: var(--gris);
    color: var(--noir);
    margin: 0;
    min-height: 100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:16px;
    box-sizing:border-box;
  }

  .banner { background:var(--noir); color:#fff; padding:10px; border-radius:10px; text-align:center; font-weight:700; margin-bottom:15px; width:100%; max-width:820px; box-sizing:border-box; }
  h1 { color:var(--orange); margin:8px 0; text-align:center; }
  .subtitle { color:#555; text-align:center; margin-bottom:18px; }

  /* Card question */
  .question {
    background:#fff;
    padding:16px;
    margin:8px auto;
    border-left:8px solid var(--orange);
    border-radius:10px;
    box-shadow:0 3px 6px rgba(0,0,0,0.08);
    width:100%;
    max-width:820px;
    box-sizing:border-box;
    text-align:center;
  }
  .question p { font-weight:600; margin:8px 0; }

  /* R√©ponses (liste) */
  .answers { display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:6px; }
  .answers label {
    display:flex; align-items:center; justify-content:center; gap:10px;
    width:100%; max-width:520px; padding:8px 10px; border-radius:8px; cursor:pointer;
    border:1px solid #eee;
  }
  .answers input[type="radio"] { transform:scale(1.05); }

  /* Boutons */
  button {
    background:var(--orange);
    color:#fff;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    font-size:1rem;
    cursor:pointer;
  }
  button[disabled] { opacity:0.6; cursor:default; }
  button:hover:not([disabled]) { background:#e65c00; }

  .footer { text-align:center; color:#777; margin-top:20px; font-size:0.9rem; }

  @media (max-width:600px) {
    .question{ padding:14px; max-width:95%; }
    .answers label{ max-width:100%; }
    button{ padding:10px 14px; }
  }
</style>
</head>
<body>

  <!-- Banniere + titre -->
  <div class="banner" id="quizBanner">üöß Les travaux de terrassement üöú</div>
  <h1>√âVALUATION</h1>
  <p class="subtitle" id="quizSubtitle">R√©pondez aux questions tir√©es au hasard</p>

  <!-- Ecran d'accueil : saisie du nom -->
  <div id="intro" style="width:100%; max-width:820px; display:flex; justify-content:center;">
    <div class="question" style="text-align:center;">
      <p><strong>Bienvenue</strong></p>
      <p>Merci d'indiquer votre nom (pas le pr√©nom) avant de commencer :</p>
      <input id="candidateName" type="text" placeholder="Nom de l'√©l√®ve"
             style="padding:8px; width:80%; max-width:320px; border-radius:6px; border:1px solid #ccc;">
      <div style="margin-top:12px;">
        <button id="startBtn" disabled>‚û°Ô∏è Suivant</button>
      </div>
    </div>
  </div>

  <!-- Conteneur des questions rendu dynamiquement -->
  <div id="quiz" style="width:100%; max-width:820px; min-height:220px; display:none; align-items:center; justify-content:center;"></div>

  <!-- Zone d'√©tat et bouton 'nouvelle √©valuation' -->
  <div style="width:100%; max-width:820px; text-align:center; margin-top:12px;">
    <button id="restartBtn" style="display:none;">üîÑ Nouvelle √©valuation</button>
    <div id="saveStatus" style="margin-top:8px; color:#444; font-size:0.95rem;"></div>
  </div>

  <p id="result" style="text-align:center; font-weight:700; margin-top:14px;"></p>
  <p class="footer">¬© Formation S√©curit√© CACES¬Æ R482A ‚Äì Quiz interactif</p>

<script>
/* ============================
   CONFIG
   ============================ */

/* Nom visible du quiz */
const QUIZ_NAME = "Les travaux de terrassement";

/* URL Google Apps Script (fourni) */
const RESULTS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzSnnlxH2dCzkVqobrQX-E4n4lo-WcxoDvmLHr7cLn35d4xploO_K3p9tNuY0OweRsW/exec";

/* ============================
   QUESTIONS (source)
   - tableau d'objets { text, answers[], correct }
   - on peut facilement modifier / ajouter des questions
   ============================ */
const allQuestions = [
  {"text":"Le conducteur travaille en sous-cavage","answers":["Vrai","Faux"],"correct":"Vrai",
   "image": "https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"},
  {"text":"Dans cette situation, il peut y avoir ensevelissement de l'engin","answers":["Vrai","Faux"],"correct":"Vrai",
   "image": "https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"},
    {"text":"Le conducteur travaille en situation de cavage","answers":["Vrai","Faux"],"correct":"Faux",
   "image": "image": "https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png" },
 ];

/* ============================
   Variables d'√©tat
   ============================ */
let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";

/* ============================
   Utilitaires
   ============================ */

/**
 * formate une date ISO en "JJ/MM/AAAA HH:MM:SS"
 */
function formatDateTime(isoString) {
  const date = new Date(isoString);
  const d = String(date.getDate()).padStart(2,'0');
  const m = String(date.getMonth()+1).padStart(2,'0');
  const y = date.getFullYear();
  const hh = String(date.getHours()).padStart(2,'0');
  const min = String(date.getMinutes()).padStart(2,'0');
  const sec = String(date.getSeconds()).padStart(2,'0');
  return `${d}/${m}/${y} ${hh}:${min}:${sec}`;
}

/**
 * Renvoie N questions al√©atoires en √©vitant celles d√©j√† sorties r√©cemment
 * (stock√©es dans localStorage sous "usedQuestions").
 */
function getRandomQuestions(num) {
  let used = JSON.parse(localStorage.getItem("usedQuestions") || "[]");
  let available = allQuestions.filter(q => !used.includes(q.text));

  // si plus assez d'items disponibles, on r√©initialise la m√©moire
  if (available.length < num) {
    used = [];
    available = [...allQuestions];
  }

  // shuffle rapide et slice
  available.sort(() => Math.random() - 0.5);
  const selected = available.slice(0, num);
  selected.forEach(q => used.push(q.text));
  localStorage.setItem("usedQuestions", JSON.stringify(used));
  return selected;
}

/* ============================
   Affichage et navigation
   ============================ */

/**
 * Affiche l'√©cran d'intro (saisie du nom)
 * NOTE: on utilise .oninput pour ne pas empiler plusieurs event listeners
 */
function showIntro() {
  document.getElementById('intro').style.display = 'flex';
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('result').textContent = '';
  document.getElementById('saveStatus').textContent = '';

  const nameInput = document.getElementById('candidateName');
  const startBtn = document.getElementById('startBtn');

  // reset valeur et bouton
  nameInput.value = "";
  startBtn.disabled = true;

  // affecte un seul handler (pas addEventListener multiple fois)
  nameInput.oninput = () => {
    startBtn.disabled = nameInput.value.trim() === "";
  };
}

/**
 * D√©marre le quiz
 */
function startQuiz() {
  candidateName = document.getElementById('candidateName').value.trim();
  if (!candidateName) return;

  // pr√©parer interface
  document.getElementById('intro').style.display = 'none';
  document.getElementById('quiz').style.display = 'flex';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('saveStatus').textContent = '';

  // tirer les questions, r√©initialiser l'√©tat
  selectedQuestions = getRandomQuestions(2);
  currentIndex = 0;
  userAnswers = new Array(selectedQuestions.length).fill("");

  // mettre √† jour le sous-titre
  document.getElementById('quizSubtitle').textContent = `R√©pondez √† ${selectedQuestions.length} questions tir√©es au hasard`;

  // afficher premi√®re question
  renderQuestion();

  // prot√©ger contre retour arri√®re simple (optionnel)
  try {
    history.pushState(null, null, location.href);
    window.addEventListener('popstate', () => history.pushState(null, null, location.href));
  } catch(e) { /* ignore */ }
}

/**
 * Affiche la question courante avec le bouton interne "Suivant/Terminer"
 * Le bouton est rendu dans la carte et activ√© seulement apr√®s s√©lection.
 */
function renderQuestion() {
  const q = selectedQuestions[currentIndex];

  // construire les options (radio)
  const optionsHtml = q.answers.map((a, idx) => {
    const inputId = `q${currentIndex}_opt${idx}`;
    return `<label for="${inputId}">
              <input id="${inputId}" type="radio" name="q" value="${a}">
              ${a}
            </label>`;
  }).join("");

  // injecter le HTML
  document.getElementById('quiz').innerHTML = `
    <div class="question">
      ${q.image ? `<img src="${q.image}" alt="Illustration question" style="max-width:100%; height:auto; margin-bottom:10px; border-radius:6px;">` : ''}
      <p>‚öôÔ∏è <strong>Question ${currentIndex + 1} :</strong> ${q.text}</p>
      <div class="answers">${optionsHtml}</div>
      <div style="margin-top:15px; text-align:center;">
        <button id="nextBtnInternal" disabled>
          ${(currentIndex === selectedQuestions.length - 1) ? "üèÅ Terminer" : "‚û°Ô∏è Suivant"}
        </button>
      </div>
    </div>
  `;

  const nextBtn = document.getElementById('nextBtnInternal');

  // activer le bouton apr√®s s√©lection
  document.querySelectorAll('input[name="q"]').forEach(radio => {
    radio.addEventListener('change', () => { nextBtn.disabled = false; });
  });

  // g√©rer le clic du bouton directement
  nextBtn.addEventListener('click', () => {
    const selected = document.querySelector('input[name="q"]:checked');
    if (!selected) return;

    userAnswers[currentIndex] = selected.value;

    if (currentIndex < selectedQuestions.length - 1) {
      currentIndex++;
      renderQuestion(); // passer √† la question suivante
    } else {
      showResults(); // fin du quiz
    }
  });
}
/**
 * Fonction appel√©e quand l'utilisateur clique sur le bouton 'Suivant' interne.
 * Elle enregistre la r√©ponse et navigue (ou termine).
 */
function nextQuestion() {
  const selection = document.querySelector('input[name="q"]:checked');
  if (!selection) return; // s√©curit√©

  // enregistrer la r√©ponse
  userAnswers[currentIndex] = selection.value;

  // si on n'est pas √† la derni√®re question, avancer
  if (currentIndex < selectedQuestions.length - 1) {
    currentIndex++;
    renderQuestion();
    return;
  }

  // sinon, fin du quiz : afficher r√©sultats et envoyer au sheet
  showResults();
}

/* ============================
   Envoi des r√©sultats (Google Sheets)
   ============================ */

/**
 * Construit l'objet qui sera envoy√© au serveur (Apps Script)
 */
function buildResultObject() {
  const now = new Date();
  let score = 0;
  const details = selectedQuestions.map((q, i) => {
    const given = userAnswers[i] || "";
    if (given === q.correct) score++;
    return { question: q.text, given: given, correct: q.correct };
  });

  return {
    timestamp: now.toISOString(),
    candidate: candidateName,
    score: score,
    total: selectedQuestions.length,
    details: details,
    quiz: QUIZ_NAME
  };
}

/**
 * Envoie les r√©sultats vers l'endpoint Google Apps Script.
 * NOTE: mode 'no-cors' utilis√© pour compatibilit√© c√¥t√© Apps Script (si besoin on peut am√©liorer).
 */
function sendResults() {
  const payload = buildResultObject();
  const statusEl = document.getElementById('saveStatus');

  if (!RESULTS_ENDPOINT) {
    statusEl.textContent = "Aucun endpoint configur√©.";
    return Promise.reject(new Error("Aucun endpoint configur√©"));
  }

  statusEl.textContent = "Envoi en cours...";

  return fetch(RESULTS_ENDPOINT, {
    method: "POST",
    mode: "no-cors", // garde ceci si ton Apps Script ne g√®re pas CORS
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(() => {
    // En mode no-cors, on ne peut pas lire la r√©ponse ; on suppose que c'est OK
    statusEl.textContent = "Envoi r√©ussi ‚úîÔ∏è";
  })
  .catch(err => {
    statusEl.textContent = "Erreur envoi: " + err.message;
    return Promise.reject(err);
  });
}

/* ============================
   Affichage final des r√©sultats
   ============================ */
function showResults() {
  // √©tat de v√©rification
  document.getElementById('quiz').innerHTML = `<div class="question"><p>‚öôÔ∏è V√©rification de vos r√©ponses...</p></div>`;
  document.getElementById('saveStatus').textContent = '';

  // envoyer puis afficher le score (m√™me si no-cors)
  sendResults().then(() => {
    const score = userAnswers.filter((ans, i) => ans === selectedQuestions[i].correct).length;
    const timestamp = formatDateTime(new Date().toISOString());

    document.getElementById('quiz').innerHTML = `
      <div class="question">
        <p>üè∑Ô∏è Candidat : <strong>${candidateName}</strong></p>
        <p>üèÅ R√©sultat : <span style="color:var(--orange); font-weight:700;">${score}</span> / ${selectedQuestions.length}</p>
        <p>‚è±Ô∏è R√©alis√© le : <strong>${timestamp}</strong></p>
      </div>
    `;
    document.getElementById('restartBtn').style.display = 'inline-block';
  })
  .catch((/*err*/) => {
    // en cas d'erreur d'envoi on affiche le message d'erreur et on propose de revenir
    document.getElementById('quiz').innerHTML = `<div class="question"><p>‚ùå Erreur lors de l'envoi des r√©sultats. Veuillez r√©essayer.</p></div>`;
    document.getElementById('restartBtn').style.display = 'inline-block';
  });
}

/* ============================
   Red√©marrer / Initialisation
   ============================ */
function restartQuiz() {
  showIntro();
}

/* Initialisation des handlers qui ne doivent √™tre attach√©s qu'une fois */
document.addEventListener('DOMContentLoaded', () => {
  // banni√®re
  document.getElementById('quizBanner').textContent = `üöß ${QUIZ_NAME} üöú`;

  // bouton d√©marrer
  document.getElementById('startBtn').addEventListener('click', startQuiz);

  // bouton recommencer
  document.getElementById('restartBtn').addEventListener('click', restartQuiz);

  // afficher √©cran d'accueil
  showIntro();
});
</script>
</body>
</html>
