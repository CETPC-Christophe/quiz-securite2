<script>
/* ============================ */
/*         CONFIG              */
/* ============================ */
const QUIZ_NAME = "Les travaux de terrassement";
const RESULTS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzSnnlxH2dCzkVqobrQX-E4n4lo-WcxoDvmLHr7cLn35d4xploO_K3p9tNuY0OweRsW/exec";

/* ============================ */
/*         QUESTIONS            */
/* ============================ */
const allQuestions = [
  {
    "text":"Le conducteur travaille en sous-cavage",
    "answers":["Vrai","Faux"],
    "correct":"Vrai",
    "image":"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  },
  {
    "text":"Dans cette situation, il peut y avoir ensevelissement de l'engin",
    "answers":["Vrai","Faux"],
    "correct":"Vrai",
    "image":"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  },
  {
    "text":"Le conducteur travaille en situation de cavage",
    "answers":["Vrai","Faux"],
    "correct":"Faux",
    "image":"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  }
];

/* ============================ */
/*         VARIABLES D'Ã‰TAT     */
/* ============================ */
let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";

/* ============================ */
/*         UTILITAIRES          */
/* ============================ */
function formatDateTime(isoString) {
  const date = new Date(isoString);
  return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()} `
       + `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`;
}

function getRandomQuestions(num) {
  let used = JSON.parse(localStorage.getItem("usedQuestions") || "[]");
  let available = allQuestions.filter(q => !used.includes(q.text));
  if (available.length < num) { used = []; available = [...allQuestions]; }
  available.sort(() => Math.random() - 0.5);
  const selected = available.slice(0, num);
  selected.forEach(q => used.push(q.text));
  localStorage.setItem("usedQuestions", JSON.stringify(used));
  return selected;
}

/* ============================ */
/*     AFFICHAGE & NAVIGATION   */
/* ============================ */
function showIntro() {
  document.getElementById('intro').style.display = 'flex';
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('result').textContent = '';
  document.getElementById('saveStatus').textContent = '';

  const nameInput = document.getElementById('candidateName');
  const startBtn = document.getElementById('startBtn');

  nameInput.value = "";
  startBtn.disabled = true;

  nameInput.oninput = () => { startBtn.disabled = nameInput.value.trim() === ""; };
}

function startQuiz() {
  candidateName = document.getElementById('candidateName').value.trim();
  if (!candidateName) return;

  document.getElementById('intro').style.display = 'none';
  document.getElementById('quiz').style.display = 'flex';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('saveStatus').textContent = '';

  selectedQuestions = getRandomQuestions(3);
  currentIndex = 0;
  userAnswers = new Array(selectedQuestions.length).fill("");

  document.getElementById('quizSubtitle').textContent =
    `RÃ©pondez Ã  ${selectedQuestions.length} questions tirÃ©es au hasard`;

  renderQuestion();
}

function renderQuestion() {
  const q = selectedQuestions[currentIndex];

  const optionsHtml = q.answers.map((a, idx) => {
    const inputId = `q${currentIndex}_opt${idx}`;
    return `<label for="${inputId}">
              <input id="${inputId}" type="radio" name="q" value="${a}">
              ${a}
            </label>`;
  }).join("");

  document.getElementById('quiz').innerHTML = `
    <div class="question">
      ${q.image ? `<img src="${q.image}" alt="Illustration" style="max-width:100%; margin-bottom:10px;">` : ""}
      <p>âš™ï¸ <strong>Question ${currentIndex + 1} :</strong> ${q.text}</p>
      <div class="answers">${optionsHtml}</div>
      <div style="margin-top:15px;">
        <button id="nextBtnInternal" disabled>
          ${(currentIndex === selectedQuestions.length - 1) ? "ğŸ Terminer" : "â¡ï¸ Suivant"}
        </button>
      </div>
    </div>
  `;

  const nextBtn = document.getElementById('nextBtnInternal');

  document.querySelectorAll('input[name="q"]').forEach(radio => {
    radio.addEventListener('change', () => { nextBtn.disabled = false; });
  });

  nextBtn.addEventListener('click', () => {
    const selected = document.querySelector('input[name="q"]:checked');
    if (!selected) return;

    userAnswers[currentIndex] = selected.value;

    if (currentIndex < selectedQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    } else {
      showResults();
    }
  });
}

/* ============================ */
/*       ENVOI & RESULTATS       */
/* ============================ */
function buildResultObject() {
  const now = new Date();
  let score = 0;
  const details = selectedQuestions.map((q,i) => {
    const given = userAnswers[i] || "";
    if (given === q.correct) score++;
    return { question: q.text, given, correct: q.correct };
  });
  return {
    timestamp: now.toISOString(),
    candidate: candidateName,
    score,
    total: selectedQuestions.length,
    details,
    quiz: QUIZ_NAME
  };
}

/*  
  ğŸ”§ IMPORTANT : sendResults() renvoie une Promise.
  MÃªme en mode "no-cors", on peut savoir quand l'appel est terminÃ©.
*/
function sendResults() {
  const payload = buildResultObject();
  const statusEl = document.getElementById('saveStatus');

  if (!RESULTS_ENDPOINT) {
    statusEl.textContent = "Aucun endpoint configurÃ©.";
    return Promise.resolve();
  }

  statusEl.textContent = "Envoi en cours...";

  return fetch(RESULTS_ENDPOINT, {
    method: "POST",
    mode: "no-cors",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })
  .then(() => {
    statusEl.textContent = "Envoi rÃ©ussi âœ”ï¸";
  })
  .catch(err => {
    statusEl.textContent = "Erreur : " + err.message;
  });
}

function showResults() {
  document.getElementById('quiz').innerHTML =
    `<div class="question"><p>âš™ï¸ VÃ©rification de vos rÃ©ponses...</p></div>`;
  document.getElementById('saveStatus').textContent = "";

  /*  
    ğŸ”§ On attend la fin de sendResults() pour afficher
       le bouton "nouvelle Ã©valuation"
  */
  sendResults().finally(() => {
    const score = userAnswers.filter((a,i)=>a===selectedQuestions[i].correct).length;
    const timestamp = formatDateTime(new Date().toISOString());

    document.getElementById('quiz').innerHTML = `
      <div class="question">
        <p>ğŸ·ï¸ Candidat : <strong>${candidateName}</strong></p>
        <p>ğŸ RÃ©sultat : <span style="color:var(--orange); font-weight:700;">
          ${score}</span> / ${selectedQuestions.length}
        </p>
        <p>â±ï¸ RÃ©alisÃ© le : <strong>${timestamp}</strong></p>
      </div>
    `;

    // ğŸ‘ Bouton visible uniquement aprÃ¨s lâ€™envoi
    document.getElementById('restartBtn').style.display = 'inline-block';
  });
}

/* ============================ */
/*        REDÃ‰MARRER            */
/* ============================ */
function restartQuiz() { showIntro(); }

/* ============================ */
/*      INITIALISATION          */
/* ============================ */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('quizBanner').textContent = `ğŸš§ ${QUIZ_NAME} ğŸšœ`;
  document.getElementById('startBtn').addEventListener('click', startQuiz);
  document.getElementById('restartBtn').addEventListener('click', restartQuiz);
  showIntro();
});
</script>
