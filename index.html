<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QCM CACES ‚Äì La fin de poste</title>
<style>
  :root {
    --orange: #ff6600;
    --noir: #222;
    --gris: #f3f3f3;
  }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: var(--gris);
    color: var(--noir);
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  #intro, #quiz {
    width: 100%;
    display: none; 
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    padding: 20px;
    box-sizing: border-box;
  }
  .banner {
    background: var(--noir);
    color: white;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    margin-bottom: 15px;
  }
  h1 {
    color: var(--orange);
    text-align: center;
    margin-bottom: 10px;
  }
  .subtitle {
    text-align: center;
    color: #555;
    margin-bottom: 25px;
  }
  .question {
    background: white;
    padding: 16px;
    margin: 8px auto;
    border-left: 8px solid var(--orange);
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 820px;
    box-sizing: border-box;
    text-align: center;
  }
  .question p {
    font-weight: 600;
    margin-bottom: 10px;
  }
  .answers {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .answers label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 8px 0;
    cursor: pointer;
    width: 100%;
    max-width: 520px;
    text-align: center;
  }
  button {
    background: var(--orange);
    color: white;
    border: none;
    padding: 12px 22px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    margin: 6px;
  }
  button:hover { background: #e65c00; }
  .result {
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    margin-top: 25px;
  }
  .footer {
    text-align: center;
    color: #777;
    margin-top: 30px;
    font-size: 0.9rem;
  }
  @media (max-width: 600px) {
    .question { padding: 14px; max-width: 95%; }
    .answers label { max-width: 100%; }
    button { padding: 10px 16px; margin:8px; }
  }
</style>
</head>
<body>

<div class="banner">üöß Formation CACES ‚Äì La fin de poste üöú</div>
<h1>QCM ‚Äì La fin de poste</h1>
<p class="subtitle" id="quizSubtitle">R√©pondez aux questions tir√©es au hasard sur la fin de poste</p>

<div id="intro">
  <div class="question">
    <p><b>Bienvenue</b></p>
    <p>Merci d'indiquer le nom du candidat avant de commencer :</p>
    <input type="text" id="candidateName" placeholder="Nom du candidat" style="padding:8px; width:80%; max-width:320px; border-radius:6px; border:1px solid #ccc;">
    <div style="margin-top:12px; text-align:center;">
      <button id="startBtn" onclick="startQuiz()" disabled>‚û°Ô∏è Suivant</button>
    </div>
  </div>
</div>

<div id="quiz"></div>

<div style="text-align:center;">
  <button id="nextBtn" onclick="nextQuestion()" disabled style="display:none;">‚û°Ô∏è Suivant</button>
  <button id="restartBtn" onclick="restartQuiz()" style="display:none;">üîÑ Nouvelle √©valuation</button>
  <div id="saveStatus" style="margin-top:8px; color:#444; font-size:0.9rem;"></div>
</div>

<p id="result" class="result"></p>
<p class="footer">¬© Formation S√©curit√© CACES ‚Äì Quiz interactif</p>

<script>
const QUIZ_NAME = "La fin de poste"; // Nom du quiz pour Google Sheets
const RESULTS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwP6EkASzl44Qh8uLieWcyqflqmMnSsP1qsfisNSJgh9pjAYE08qm0-zi5fg-w8F_cRRQ/exec';

const allQuestions = [
  {text:"Le nettoyage de l'engin fait partie des op√©rations de fin de poste.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le conducteur doit garer l'engin sur une zone en pente pour le stationner.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Le stationnement de l'engin doit se faire sur un sol stable et plan.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Il n'est pas n√©cessaire d'abaisser les accessoires de travail avant d'arr√™ter l'engin.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Avant de quitter l'engin, le conducteur doit couper le contact et retirer la cl√©.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le plein de carburant doit √™tre r√©alis√© moteur allum√© pour gagner du temps.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Les v√©rifications de fuite d'huile ou de carburant peuvent √™tre effectu√©es √† chaud.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Les niveaux (huile, carburant, liquide de refroidissement) doivent √™tre v√©rifi√©s √† la fin de chaque poste.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le graissage des articulations fait partie des op√©rations de maintenance de fin de poste.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le nettoyage du poste de conduite est facultatif.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Les anomalies constat√©es doivent √™tre signal√©es √† la hi√©rarchie.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le carnet de maintenance n'a pas besoin d'√™tre mis √† jour quotidiennement.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Le moteur doit √™tre arr√™t√© avant tout entretien ou graissage.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Les flexibles hydrauliques peuvent √™tre manipul√©s m√™me sous pression.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Le conducteur doit signaler tout bruit ou comportement anormal de l'engin.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Les √©quipements de protection individuelle peuvent √™tre rang√©s √† la fin du poste.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Le nettoyage de l'engin permet de d√©tecter d'√©ventuelles anomalies.", answers:["Vrai","Faux"], correct:"Vrai"},
  {text:"Les cl√©s peuvent √™tre laiss√©es sur le contact si le site est s√©curis√©.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Les freins doivent √™tre desserr√©s avant le stationnement.", answers:["Vrai","Faux"], correct:"Faux"},
  {text:"Le remplissage du r√©servoir de carburant doit se faire dans un endroit ventil√©.", answers:["Vrai","Faux"], correct:"Vrai"}
];

let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = '';

// üîπ Formater l'heure en JJ/MM/AAAA HH:MM:SS
function formatDateTime(isoString) {
  const date = new Date(isoString);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth()+1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2,'0');
  const minutes = String(date.getMinutes()).padStart(2,'0');
  const seconds = String(date.getSeconds()).padStart(2,'0');
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

// üîπ Tirage al√©atoire des questions
function getRandomQuestions(num) {
  let used = JSON.parse(localStorage.getItem("usedQuestions") || "[]");
  let available = allQuestions.filter(q => !used.includes(q.text));
  if (available.length < num) { used = []; available = [...allQuestions]; }
  available.sort(() => Math.random() - 0.5);
  const selected = available.slice(0, num);
  selected.forEach(q => used.push(q.text));
  localStorage.setItem("usedQuestions", JSON.stringify(used));
  return selected;
}

// üîπ Affichage de l'√©cran d'accueil
function showIntro() {
  document.getElementById('intro').style.display = 'flex';
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('result').innerHTML = '';
  document.getElementById('saveStatus').innerHTML = '';
  const nameInput = document.getElementById('candidateName');
  const startBtn = document.getElementById('startBtn');
  nameInput.value = '';
  startBtn.disabled = true;
  nameInput.addEventListener('input', () => { startBtn.disabled = nameInput.value.trim() === ''; });
}

// üîπ D√©marrage du quiz
function startQuiz() {
  candidateName = document.getElementById('candidateName').value.trim();
  if (!candidateName) return;
  document.getElementById('intro').style.display = 'none';
  document.getElementById('quiz').style.display = 'flex';
  document.getElementById('nextBtn').style.display = 'inline-block';
  document.getElementById('restartBtn').style.display = 'none';
  selectedQuestions = getRandomQuestions(2);
  currentIndex = 0;
  userAnswers = new Array(selectedQuestions.length);
  document.getElementById('quizSubtitle').textContent = `R√©pondez √† ${selectedQuestions.length} questions tir√©es au hasard sur la fin de poste`;
  renderQuestion();
  try { history.pushState(null, null, location.href); window.addEventListener('popstate', () => history.pushState(null, null, location.href)); } catch (e) {}
}

// üîπ Affichage d'une question
function renderQuestion() {
  const q = selectedQuestions[currentIndex];
  const options = q.answers.map(a => `<label><input type="radio" name="q" value="${a}"> ${a}</label>`).join("");
  document.getElementById("quiz").innerHTML = `<div class="question"><p>‚öôÔ∏è <b>Question ${currentIndex+1} :</b> ${q.text}</p><div class="answers">${options}</div></div>`;
  const nextBtn = document.getElementById("nextBtn");
  nextBtn.disabled = true;
  nextBtn.textContent = (currentIndex === selectedQuestions.length - 1) ? "üèÅ Terminer" : "‚û°Ô∏è Suivant";
  document.querySelectorAll('input[name="q"]').forEach(r => r.addEventListener('change', () => { nextBtn.disabled = false; }));
}

// üîπ Passage √† la question suivante
function nextQuestion() {
  const selected = document.querySelector('input[name="q"]:checked');
  if (!selected) return;
  userAnswers[currentIndex] = selected.value;
  if (currentIndex < selectedQuestions.length - 1) { currentIndex++; renderQuestion(); } 
  else { showResults(); }
}

// üîπ Construction de l'objet √† envoyer
function buildResultObject() {
  const now = new Date();
  let score = 0;
  const details = selectedQuestions.map((q, i) => {
    const given = userAnswers[i] || '';
    if (given === q.correct) score++;
    return { question: q.text, given: given, correct: q.correct };
  });
  return {
    timestamp: now.toISOString(),
    candidate: candidateName,
    score: score,
    total: selectedQuestions.length,
    details: details,
    quiz: "La fin de poste" // Nom du quiz pour Google Sheets
  };
}

// üîπ Envoi des r√©sultats
function sendResults() {
  const payload = buildResultObject();
  const statusEl = document.getElementById('saveStatus');
  if (!RESULTS_ENDPOINT) { statusEl.textContent = 'Aucun endpoint configur√©.'; return Promise.reject(new Error('Aucun endpoint configur√©')); }
  statusEl.textContent = 'Envoi en cours...';
  return fetch(RESULTS_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => { statusEl.textContent = 'Envoi r√©ussi ‚úîÔ∏è'; })
    .catch(err => { statusEl.textContent = 'Erreur envoi: ' + err.message; return Promise.reject(err); });
}

// üîπ Affichage des r√©sultats
function showResults() {
  document.getElementById("quiz").innerHTML = `<div class="question"><p>‚öôÔ∏è V√©rification de vos r√©ponses...</p></div>`;
  document.getElementById("nextBtn").style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  sendResults().then(() => {
    let score = 0;
    selectedQuestions.forEach((q, i) => { if (userAnswers[i] === q.correct) score++; });
    const timestamp = formatDateTime(new Date().toISOString());
    document.getElementById("quiz").innerHTML = `<div class="question">
      <p>üè∑Ô∏è Candidat : <b>${candidateName}</b></p>
      <p>üèÅ R√©sultat : <span style="color:var(--orange);">${score}</span> / ${selectedQuestions.length}</p>
      <p>‚è±Ô∏è R√©alis√© le : <b>${timestamp}</b></p>
    </div>`;
    document.getElementById('restartBtn').style.display = 'inline-block';
  }).catch(err => {
    document.getElementById("quiz").innerHTML = `<div class="question"><p>‚ùå Erreur lors de l'envoi des r√©sultats. Veuillez r√©essayer.</p></div>`;
    document.getElementById('restartBtn').style.display = 'inline-block';
  });
}

// üîπ Recommencer le quiz
function restartQuiz() { showIntro(); }

// üîπ Initialisation
showIntro();
</script>
</body>
</html>

