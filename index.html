<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>QCM CACES ‚Äì Les travaux de terrassement</title>

<style>
:root { --orange:#ff6600; --noir:#222; --gris:#f3f3f3; }

body{
  font-family:Segoe UI,Tahoma,sans-serif;
  background:var(--gris);
  margin:0; padding:16px;
  display:flex; flex-direction:column;
  align-items:center;
}

.banner{
  background:var(--noir);
  color:#fff;
  padding:10px;
  border-radius:10px;
  max-width:820px;
  width:100%;
  text-align:center;
  font-weight:700;
  margin-bottom:15px;
}

.question{
  background:#fff;
  border-left:8px solid var(--orange);
  padding:16px;
  border-radius:10px;
  max-width:820px;
  width:100%;
  text-align:center;
  box-shadow:0 3px 6px rgba(0,0,0,0.1);
}

.answers{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:10px;
}

.answers label{
  border:1px solid #ddd;
  border-radius:6px;
  padding:8px;
  cursor:pointer;
}

button{
  background:var(--orange);
  border:none;
  padding:10px 18px;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  margin-top:10px;
}
button[disabled]{ opacity:0.6; cursor:default; }
</style>
</head>

<body>

<div class="banner" id="quizBanner"></div>
<h1 style="color:var(--orange)">√âVALUATION</h1>
<p id="quizSubtitle">R√©pondez aux questions tir√©es au hasard</p>

<!-- INTRO -->
<div id="intro" style="max-width:820px; width:100%;">
  <div class="question">
    <p><strong>Bienvenue</strong></p>
    <p>Merci d'indiquer votre nom :</p>
    <input id="candidateName" type="text"
           placeholder="Nom"
           style="padding:8px; width:80%; max-width:300px;">
    <br>
    <button id="startBtn" disabled>‚û°Ô∏è Suivant</button>
  </div>
</div>

<!-- QUIZ -->
<div id="quiz" style="display:none; width:100%; max-width:820px;"></div>

<!-- RESTART -->
<div style="text-align:center; max-width:820px; width:100%;">
  <button id="restartBtn" style="display:none;">üîÑ Nouvelle √©valuation</button>
  <div id="saveStatus" style="margin-top:10px;"></div>
</div>

<script>
/* ---------------------- CONFIG ---------------------- */
const QUIZ_NAME = "Les travaux de terrassement";
const RESULTS_ENDPOINT =
"https://script.google.com/macros/s/AKfycbzSnnlxH2dCzkVqobrQX-E4n4lo-WcxoDvmLHr7cLn35d4xploO_K3p9tNuY0OweRsW/exec";

/* ---------------------- QUESTIONS ---------------------- */
const allQuestions = [
  {
    text:"Le conducteur travaille en sous-cavage",
    answers:["Vrai","Faux"],
    correct:"Vrai",
    image:"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  },
  {
    text:"Dans cette situation, il peut y avoir ensevelissement de l'engin",
    answers:["Vrai","Faux"],
    correct:"Vrai",
    image:"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  },
  {
    text:"Le conducteur travaille en situation de cavage",
    answers:["Vrai","Faux"],
    correct:"Faux",
    image:"https://raw.githubusercontent.com/CETPC-Christophe/09-Les-travaux-de-terrassement/refs/heads/main/images/Souscavage.png"
  }
];

/* ---------------------- VARIABLES ---------------------- */
let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";

/* ---------------------- INTRO ---------------------- */
document.getElementById("quizBanner").textContent = "üöß " + QUIZ_NAME + " üöú";

document.getElementById("candidateName").addEventListener("input", () => {
  document.getElementById("startBtn").disabled =
    document.getElementById("candidateName").value.trim() === "";
});

document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("restartBtn").addEventListener("click", showIntro);

function showIntro(){
  document.getElementById("intro").style.display = "block";
  document.getElementById("quiz").style.display = "none";
  document.getElementById("restartBtn").style.display = "none";
  document.getElementById("saveStatus").textContent = "";
}

/* ---------------------- QUIZ ---------------------- */
function startQuiz(){
  candidateName = document.getElementById("candidateName").value.trim();
  if(!candidateName) return;

  selectedQuestions = allQuestions.sort(()=>Math.random()-0.5).slice(0,3);
  userAnswers = [];

  currentIndex = 0;

  document.getElementById("intro").style.display = "none";
  document.getElementById("quiz").style.display = "block";

  renderQuestion();
}

function renderQuestion(){
  const q = selectedQuestions[currentIndex];

  const answersHTML = q.answers.map((ans, i)=>`
    <label>
      <input type="radio" name="q" value="${ans}">
      ${ans}
    </label>
  `).join("");

  document.getElementById("quiz").innerHTML = `
    <div class="question">
      ${q.image ? `<img src="${q.image}" style="max-width:100%; border-radius:6px;">` : ""}
      <p><strong>Question ${currentIndex+1} :</strong> ${q.text}</p>
      <div class="answers">${answersHTML}</div>
      <button id="nextBtn" disabled>
        ${currentIndex === selectedQuestions.length-1 ? "üèÅ Terminer" : "‚û°Ô∏è Suivant"}
      </button>
    </div>
  `;

  const nextBtn = document.getElementById("nextBtn");

  document.querySelectorAll('input[name="q"]').forEach(r => {
    r.addEventListener("change", () => nextBtn.disabled = false);
  });

  nextBtn.addEventListener("click", ()=>{
    const val = document.querySelector('input[name="q"]:checked').value;
    userAnswers[currentIndex] = val;

    if(currentIndex < selectedQuestions.length-1){
      currentIndex++;
      renderQuestion();
    } else {
      showResults();
    }
  });
}

/* ---------------------- RESULTATS ---------------------- */
function showResults(){
  document.getElementById("quiz").innerHTML = "<div class='question'>Envoi...</div>";
  sendResults().finally(()=>{

    const score = userAnswers.filter((v,i)=>v===selectedQuestions[i].correct).length;
    const now = new Date().toLocaleString();

    document.getElementById("quiz").innerHTML = `
      <div class="question">
        <p>Candidat : <strong>${candidateName}</strong></p>
        <p>R√©sultat : <strong>${score}/${selectedQuestions.length}</strong></p>
        <p>${now}</p>
      </div>
    `;

    document.getElementById("restartBtn").style.display = "inline-block";
  });
}

function sendResults(){
  const payload = {
    timestamp: new Date().toISOString(),
    candidate: candidateName,
    score: userAnswers.filter((v,i)=>v===selectedQuestions[i].correct).length,
    total: selectedQuestions.length,
    answers: userAnswers,
    quiz: QUIZ_NAME
  };

  document.getElementById("saveStatus").textContent = "‚öôÔ∏è V√©rification de vos r√©ponses...";

  return fetch(RESULTS_ENDPOINT,{
    method:"POST",
    mode:"no-cors",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  }).then(()=>{
    document.getElementById("saveStatus").textContent = "Envoi r√©ussi ‚úîÔ∏è";
  }).catch(()=>{
    document.getElementById("saveStatus").textContent = "Erreur d‚Äôenvoi ‚ö†Ô∏è";
  });
}
</script>

</body>
</html>

